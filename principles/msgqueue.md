### Message Queue

Why Message Queue?

- decouple processing between message producer and consumer
- enable work queues (distribute tasks among workers in a load balanced fashion)
- provide robustness for failing message consumers (backoff, retry)

The message queue is the third stop in our messaging workflow. The message queue holds the messages generated by the producer and store it in one or more of the following:

1. In memory (like NSQ)
2. Disk (like Dynamiq on top of Riak)
3. Hybrid (in case of NSQ, once a threshold called high-water mark is reached, messages are persisted to disk)

Each message queue has its own way of setting up communication with message consumers (or clients) but the general flow is like these:

1. Message queue pushes message to consumer
2. Consumer processes message. If successful within arbitrary time, consumer sends success acknowledgment otherwise it sends failure signal.
3. Message receives acknowledgment. If success, message will be removed from the queue (dequeue). If failure, the message will be put
back to queue (auto-requeue).
4. Go back to step 1

In the case of NSQ, if a message consumer keeps on failing to process the message, NSQ will try to slow down pushing that same message to
consumers (a process called backoff). After an arbitrary time has elapsed, NSQ will retry to push that same message.

In this guide, we are going to use [NSQ](http://nsq.io).

**Why NSQ?**

NSQ - a realtime distributed messaging platform (written in Go)

Architecture:

nsqd <------> nsqlookupd <------> nsq clients

**nsqd** - the daemon that receives, queues, and delivers messages to clients.

- processes messages produced by nsq clients
- registers itself to nsqlookupd
- by default, listens on port 4150 (for TCP clients), 4151 (for HTTP clients)
- receives messages
- queue and re-queue messages
- broadcast topics and channels to nsqlookupd
- nsqd has a built-in Web server (so you can publish messages using HTTP)

**nsqlookupd** - the daemon that manages topology information.

- clients query nsqlookupd to discover nsqd producers for a specific topic information
- by default, listens on port 4160 (for TCP clients), 4161 (for HTTP clients)
- must have static IP address as much as possible
- no need for etcd, Consul or Zookeeper
- can run on a node (physical or virtual machine) apart from nsqd

**nsq clients**

- official client libraries in Go, Python, JavaScript
- registers itself to nsqlookupd (for scalability)
- clients are apps that produce or consume messages (can be both at the same time)
